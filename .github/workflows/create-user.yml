name: Create User Account

on:
  workflow_dispatch:
    inputs:
      edipi_encrypted:
        description: 'Encrypted EDIPI (base64)'
        required: true
        type: string
      email:
        description: 'User email address'
        required: true
        type: string
      password_hash:
        description: 'Password hash (base64)'
        required: true
        type: string
      personnel_id:
        description: 'Personnel ID (optional)'
        required: false
        type: string
        default: ''

permissions:
  contents: write

jobs:
  create-user:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate inputs
        run: |
          if [ -z "${{ inputs.edipi_encrypted }}" ]; then
            echo "Error: edipi_encrypted is required"
            exit 1
          fi
          if [ -z "${{ inputs.email }}" ]; then
            echo "Error: email is required"
            exit 1
          fi
          if [ -z "${{ inputs.password_hash }}" ]; then
            echo "Error: password_hash is required"
            exit 1
          fi

      - name: Generate user ID and check if user exists
        id: user-check
        run: |
          # Generate a unique user ID using UUID
          USER_ID=$(cat /proc/sys/kernel/random/uuid)
          echo "user_id=${USER_ID}" >> $GITHUB_OUTPUT

          # Check if user with this EDIPI already exists in any file
          if grep -r '"edipi_encrypted": "${{ inputs.edipi_encrypted }}"' public/data/user/ 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "User with this EDIPI already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create user JSON file
        if: steps.user-check.outputs.exists != 'true'
        run: |
          # Create user directory if it doesn't exist
          mkdir -p public/data/user

          USER_ID="${{ steps.user-check.outputs.user_id }}"
          CREATED_AT=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")

          # Determine personnel_id value
          PERSONNEL_ID='null'
          if [ -n "${{ inputs.personnel_id }}" ]; then
            PERSONNEL_ID='"${{ inputs.personnel_id }}"'
          fi

          # Create user JSON file named by user ID
          cat > "public/data/user/${USER_ID}.json" << EOF
          {
            "id": "${USER_ID}",
            "edipi_encrypted": "${{ inputs.edipi_encrypted }}",
            "email": "${{ inputs.email }}",
            "personnel_id": ${PERSONNEL_ID},
            "password_hash": "${{ inputs.password_hash }}",
            "roles": [
              {
                "id": "role-${USER_ID}-standard",
                "role_name": "Standard User",
                "scope_unit_id": null,
                "created_at": "${CREATED_AT}"
              }
            ],
            "created_at": "${CREATED_AT}"
          }
          EOF

          echo "Created user file: public/data/user/${USER_ID}.json"

      - name: Update users-index.json
        if: steps.user-check.outputs.exists != 'true'
        run: |
          INDEX_FILE="public/data/users-index.json"
          USER_ID="${{ steps.user-check.outputs.user_id }}"

          # Read current index or create new one
          if [ -f "$INDEX_FILE" ]; then
            # Check if user already in index by EDIPI
            if grep -q '"edipi_encrypted": "${{ inputs.edipi_encrypted }}"' "$INDEX_FILE"; then
              echo "User already in index, skipping"
              exit 0
            fi

            # Add new user to existing index using jq
            jq --arg id "$USER_ID" \
               --arg edipi "${{ inputs.edipi_encrypted }}" \
               --arg email "${{ inputs.email }}" \
               '.users += [{"id": $id, "edipi_encrypted": $edipi, "email": $email}] | .updatedAt = (now | todate)' \
               "$INDEX_FILE" > "${INDEX_FILE}.tmp" && mv "${INDEX_FILE}.tmp" "$INDEX_FILE"
          else
            # Create new index file
            cat > "$INDEX_FILE" << EOF
          {
            "users": [
              {
                "id": "${USER_ID}",
                "edipi_encrypted": "${{ inputs.edipi_encrypted }}",
                "email": "${{ inputs.email }}"
              }
            ],
            "version": "1.0",
            "updatedAt": "$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")",
            "description": "Index of seed user accounts. User files are stored in /data/user/{id}.json"
          }
          EOF
          fi

          echo "Updated users-index.json"

      - name: Commit and push changes
        if: steps.user-check.outputs.exists != 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add public/data/user/ public/data/users-index.json
          git commit -m "feat: Add new user account (${{ inputs.email }})"
          git push

      - name: Trigger deployment
        if: steps.user-check.outputs.exists != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deploy.yml',
              ref: 'main'
            });
            console.log('Triggered deployment workflow');

      - name: Output result
        run: |
          if [ "${{ steps.user-check.outputs.exists }}" == "true" ]; then
            echo "::warning::User already exists"
          else
            echo "::notice::User created successfully with ID: ${{ steps.user-check.outputs.user_id }}"
          fi
